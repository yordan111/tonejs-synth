<!DOCTYPE html>
<html>
<head>
    <title>Tone.js Synth with ADSR & Unison</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .synth-container {
            background: #2d2d2d;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4fc3f7;
        }
        .control-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        select, input[type="range"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: #3d3d3d;
            border: 1px solid #555;
            border-radius: 5px;
            color: white;
        }
        .slider-value {
            text-align: center;
            font-size: 0.9em;
            color: #4fc3f7;
            margin-top: 5px;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        #startBtn {
            background: #4caf50;
            color: white;
        }
        #stopBtn {
            background: #f44336;
            color: white;
        }
        #playBtn {
            background: #2196f3;
            color: white;
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            background: #333;
        }
        
        /* ADD THIS NEW CSS FOR FILTER/VOLUME DISPLAY */
        #lowCutValue, #highCutValue, #volumeValue {
            color: #ff9800;
            font-weight: normal;
        }
        
        /* Style for ADSR controls */
        .adsr-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .unison-controls {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        /* ADSR envelope visualization */
        .adsr-visual {
            width: 100%;
            height: 100px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 5px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .adsr-path {
            fill: none;
            stroke: #4fc3f7;
            stroke-width: 3;
        }
    </style>
</head>
<body>
    <div class="synth-container">
        <h1>Tone.js Synthesizer with ADSR & Unison</h1>
        
        <!-- Waveform Selector -->
        <div class="control-group">
            <label for="waveform">Waveform Type:</label>
            <select id="waveform">
                <option value="sine">Sine Wave</option>
                <option value="square">Square Wave</option>
                <option value="sawtooth">Sawtooth Wave</option>
                <option value="triangle">Triangle Wave</option>
            </select>
        </div>
        
        <!-- Frequency Control -->
        <div class="control-group">
            <label for="frequency">Frequency (Hz): 
                <span id="frequencyValue">440</span>
            </label>
            <input type="range" id="frequency" min="50" max="2000" value="440" step="1">
        </div>
        
        <!-- Detune Control -->
        <div class="control-group">
            <label for="detune">Detune (cents): 
                <span id="detuneValue">0</span>
            </label>
            <input type="range" id="detune" min="-1200" max="1200" value="0" step="1">
        </div>
        
        <!-- NEW UNISON CONTROLS -->
        <div class="unison-controls">
            <div class="control-group">
                <label for="unisonVoices">Unison Voices: 
                    <span id="unisonVoicesValue">4</span>
                </label>
                <input type="range" id="unisonVoices" min="1" max="8" value="4" step="1">
            </div>
            
            <div class="control-group">
                <label for="unisonDetune">Unison Detune (cents): 
                    <span id="unisonDetuneValue">10</span>
                </label>
                <input type="range" id="unisonDetune" min="0" max="100" value="10" step="1">
            </div>
            
            <div class="control-group">
                <label for="unisonSpread">Unison Spread: 
                    <span id="unisonSpreadValue">0.5</span>
                </label>
                <input type="range" id="unisonSpread" min="0" max="1" value="0.5" step="0.01">
            </div>
        </div>
        
        <!-- NEW ADSR ENVELOPE CONTROLS -->
        <div class="adsr-controls">
            <div class="control-group">
                <label for="attack">Attack (sec): 
                    <span id="attackValue">0.1</span>
                </label>
                <input type="range" id="attack" min="0" max="2" value="0.1" step="0.01">
            </div>
            
            <div class="control-group">
                <label for="decay">Decay (sec): 
                    <span id="decayValue">0.2</span>
                </label>
                <input type="range" id="decay" min="0" max="2" value="0.2" step="0.01">
            </div>
            
            <div class="control-group">
                <label for="sustain">Sustain (0-1): 
                    <span id="sustainValue">0.7</span>
                </label>
                <input type="range" id="sustain" min="0" max="1" value="0.7" step="0.01">
            </div>
            
            <div class="control-group">
                <label for="release">Release (sec): 
                    <span id="releaseValue">0.5</span>
                </label>
                <input type="range" id="release" min="0" max="3" value="0.5" step="0.01">
            </div>
        </div>
        
        <!-- ADSR Visualization -->
        <div class="control-group">
            <label>ADSR Envelope:</label>
            <div class="adsr-visual">
                <svg width="100%" height="100%" id="adsrVisual">
                    <!-- ADSR path will be drawn here -->
                </svg>
            </div>
        </div>
        
        <!-- FILTER AND VOLUME CONTROLS -->
        <!-- Low Cut Filter -->
        <div class="control-group">
            <label for="lowCut">Low Cut (Hz): 
                <span id="lowCutValue">20</span>
            </label>
            <input type="range" id="lowCut" min="20" max="1000" value="20" step="1">
        </div>
        
        <!-- High Cut Filter -->
        <div class="control-group">
            <label for="highCut">High Cut (Hz): 
                <span id="highCutValue">20000</span>
            </label>
            <input type="range" id="highCut" min="1000" max="20000" value="20000" step="100">
        </div>
        
        <!-- Volume Control -->
        <div class="control-group">
            <label for="volume">Volume (dB): 
                <span id="volumeValue">0</span>
            </label>
            <input type="range" id="volume" min="-60" max="0" value="0" step="1">
        </div>
        
        <!-- Buttons -->
        <div class="button-group">
            <button id="startBtn">Start Audio</button>
            <button id="stopBtn" disabled>Stop Audio</button>
            <button id="playBtn" disabled>Play Note</button>
        </div>
        
        <!-- Status Display -->
        <div class="status" id="status">Click "Start Audio" to begin</div>
    </div>

    <script>
        // Initialize variables
        let synth = null;
        let lowCutFilter = null;
        let highCutFilter = null;
        let volumeNode = null;
        let isPlaying = false;
        let audioStarted = false;
        let oscillators = []; // Array to hold multiple oscillators for unison
        
        // DOM Elements
        const waveformSelect = document.getElementById('waveform');
        const frequencySlider = document.getElementById('frequency');
        const frequencyValue = document.getElementById('frequencyValue');
        const detuneSlider = document.getElementById('detune');
        const detuneValue = document.getElementById('detuneValue');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const playBtn = document.getElementById('playBtn');
        const statusDiv = document.getElementById('status');
        const adsrVisual = document.getElementById('adsrVisual');
        
        // Filter and volume controls
        const lowCutSlider = document.getElementById('lowCut');
        const lowCutValue = document.getElementById('lowCutValue');
        const highCutSlider = document.getElementById('highCut');
        const highCutValue = document.getElementById('highCutValue');
        const volumeSlider = document.getElementById('volume');
        const volumeValue = document.getElementById('volumeValue');
        
        // NEW ADSR Controls
        const attackSlider = document.getElementById('attack');
        const attackValue = document.getElementById('attackValue');
        const decaySlider = document.getElementById('decay');
        const decayValue = document.getElementById('decayValue');
        const sustainSlider = document.getElementById('sustain');
        const sustainValue = document.getElementById('sustainValue');
        const releaseSlider = document.getElementById('release');
        const releaseValue = document.getElementById('releaseValue');
        
        // NEW UNISON Controls
        const unisonVoicesSlider = document.getElementById('unisonVoices');
        const unisonVoicesValue = document.getElementById('unisonVoicesValue');
        const unisonDetuneSlider = document.getElementById('unisonDetune');
        const unisonDetuneValue = document.getElementById('unisonDetuneValue');
        const unisonSpreadSlider = document.getElementById('unisonSpread');
        const unisonSpreadValue = document.getElementById('unisonSpreadValue');
        
        // Update display values for sliders
        frequencySlider.addEventListener('input', () => {
            frequencyValue.textContent = frequencySlider.value;
            updateADSRVisualization();
        });
        
        detuneSlider.addEventListener('input', () => {
            detuneValue.textContent = detuneSlider.value;
        });
        
        // Filter and volume listeners
        lowCutSlider.addEventListener('input', () => {
            lowCutValue.textContent = lowCutSlider.value;
            if (lowCutFilter) {
                lowCutFilter.frequency.value = parseFloat(lowCutSlider.value);
            }
        });
        
        highCutSlider.addEventListener('input', () => {
            highCutValue.textContent = highCutSlider.value;
            if (highCutFilter) {
                highCutFilter.frequency.value = parseFloat(highCutSlider.value);
            }
        });
        
        volumeSlider.addEventListener('input', () => {
            volumeValue.textContent = volumeSlider.value;
            if (volumeNode) {
                volumeNode.volume.value = parseFloat(volumeSlider.value);
            }
        });
        
        // Waveform change handler
        waveformSelect.addEventListener('change', () => {
            updateADSRVisualization();
        });
        
        // NEW: ADSR Slider Listeners
        attackSlider.addEventListener('input', () => {
            attackValue.textContent = attackSlider.value;
            updateADSRVisualization();
        });
        
        decaySlider.addEventListener('input', () => {
            decayValue.textContent = decaySlider.value;
            updateADSRVisualization();
        });
        
        sustainSlider.addEventListener('input', () => {
            sustainValue.textContent = sustainSlider.value;
            updateADSRVisualization();
        });
        
        releaseSlider.addEventListener('input', () => {
            releaseValue.textContent = releaseSlider.value;
            updateADSRVisualization();
        });
        
        // NEW: UNISON Slider Listeners
        unisonVoicesSlider.addEventListener('input', () => {
            unisonVoicesValue.textContent = unisonVoicesSlider.value;
        });
        
        unisonDetuneSlider.addEventListener('input', () => {
            unisonDetuneValue.textContent = unisonDetuneSlider.value;
        });
        
        unisonSpreadSlider.addEventListener('input', () => {
            unisonSpreadValue.textContent = unisonSpreadSlider.value;
        });
        
        // Function to create multiple oscillators for unison
        function createUnisonOscillators(freq, type, detune) {
            oscillators = [];
            const voices = parseInt(unisonVoicesSlider.value);
            const spread = parseFloat(unisonSpreadSlider.value);
            const unisonDetune = parseFloat(unisonDetuneSlider.value);
            
            // Create master gain node for all oscillators
            const masterGain = new Tone.Gain(1);
            
            for (let i = 0; i < voices; i++) {
                // Calculate detune for this voice
                // Spread creates voices on both sides of center frequency
                const voicePosition = (i / (voices - 1)) * 2 - 1; // -1 to 1
                const voiceDetune = detune + (voicePosition * unisonDetune * spread);
                
                // Create oscillator
                const osc = new Tone.Oscillator({
                    frequency: freq,
                    type: type,
                    detune: voiceDetune,
                    phase: (i / voices) * 360 // Stagger phases for richer sound
                });
                
                // Create individual gain for each oscillator
                const voiceGain = new Tone.Gain(1 / Math.sqrt(voices)); // Normalize volume
                
                // Connect: Oscillator → Voice Gain → Master Gain
                osc.connect(voiceGain);
                voiceGain.connect(masterGain);
                
                oscillators.push({
                    oscillator: osc,
                    gain: voiceGain
                });
            }
            
            return masterGain;
        }
        
        // Function to update ADSR visualization
        function updateADSRVisualization() {
            const width = adsrVisual.clientWidth;
            const height = adsrVisual.clientHeight;
            
            // Clear previous visualization
            adsrVisual.innerHTML = '';
            
            // Calculate time values
            const attack = parseFloat(attackSlider.value);
            const decay = parseFloat(decaySlider.value);
            const sustain = parseFloat(sustainSlider.value);
            const release = parseFloat(releaseSlider.value);
            
            // Total width for A+D+S
            const totalADS = attack + decay + 0.5; // 0.5 seconds for sustain display
            
            // Scale factors
            const xScale = width / (totalADS + release + 0.5); // Add some extra for release display
            const yScale = height * 0.9; // 90% of height for the envelope
            
            // Create path
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            
            // Build path points
            let pathData = `M 0 ${height} `; // Start at bottom left
            
            // Attack phase
            const attackX = attack * xScale;
            pathData += `L ${attackX} ${height - yScale} `;
            
            // Decay phase
            const decayX = attackX + (decay * xScale);
            const sustainY = height - (sustain * yScale);
            pathData += `L ${decayX} ${sustainY} `;
            
            // Sustain phase (horizontal line)
            const sustainX = decayX + (0.5 * xScale); // 0.5 seconds of sustain display
            pathData += `L ${sustainX} ${sustainY} `;
            
            // Release phase
            const releaseX = sustainX + (release * xScale);
            pathData += `L ${releaseX} ${height} `;
            
            // Close path
            pathData += `L ${width} ${height}`;
            
            path.setAttribute("d", pathData);
            path.setAttribute("class", "adsr-path");
            
            adsrVisual.appendChild(path);
            
            // Add labels
            addLabel(adsrVisual, "A", attackX / 2, height - 10);
            addLabel(adsrVisual, "D", attackX + (decayX - attackX) / 2, height - 10);
            addLabel(adsrVisual, "S", decayX + (sustainX - decayX) / 2, height - 10);
            addLabel(adsrVisual, "R", sustainX + (releaseX - sustainX) / 2, height - 10);
        }
        
        function addLabel(svg, text, x, y) {
            const textEl = document.createElementNS("http://www.w3.org/2000/svg", "text");
            textEl.setAttribute("x", x);
            textEl.setAttribute("y", y);
            textEl.setAttribute("text-anchor", "middle");
            textEl.setAttribute("fill", "#888");
            textEl.setAttribute("font-size", "12");
            textEl.textContent = text;
            svg.appendChild(textEl);
        }
        
        // Start Audio Context
        startBtn.addEventListener('click', async () => {
            try {
                // Start Tone.js audio context
                await Tone.start();
                
                // Create audio nodes
                createAudioNodes();
                
                // Initialize ADSR visualization
                updateADSRVisualization();
                
                audioStarted = true;
                statusDiv.textContent = "Audio started! Click 'Play Note' to hear sound";
                statusDiv.style.background = "#2e7d32";
                
                // Enable/disable buttons
                startBtn.disabled = true;
                stopBtn.disabled = false;
                playBtn.disabled = false;
                
                console.log("Audio context started successfully");
            } catch (error) {
                statusDiv.textContent = "Error starting audio: " + error.message;
                statusDiv.style.background = "#c62828";
                console.error("Error starting audio:", error);
            }
        });
        
        // Stop Audio
        stopBtn.addEventListener('click', () => {
            if (isPlaying) {
                stopNote();
            }
            
            audioStarted = false;
            statusDiv.textContent = "Audio stopped. Click 'Start Audio' to begin again";
            statusDiv.style.background = "#333";
            
            // Enable/disable buttons
            startBtn.disabled = false;
            stopBtn.disabled = true;
            playBtn.disabled = true;
            playBtn.textContent = "Play Note";
            
            console.log("Audio stopped");
        });
        
        // Play/Stop Note
        playBtn.addEventListener('click', async () => {
            if (!audioStarted) {
                statusDiv.textContent = "Please start audio first!";
                return;
            }
            
            if (!isPlaying) {
                await playNote();
            } else {
                stopNote();
            }
        });
        
        // Function to play note with unison and ADSR
        async function playNote() {
            try {
                // Stop any existing sound
                if (oscillators.length > 0) {
                    oscillators.forEach(({ oscillator }) => oscillator.stop());
                    oscillators = [];
                }
                
                // Create ADSR envelope
                const adsrEnvelope = new Tone.AmplitudeEnvelope({
                    attack: parseFloat(attackSlider.value),
                    decay: parseFloat(decaySlider.value),
                    sustain: parseFloat(sustainSlider.value),
                    release: parseFloat(releaseSlider.value)
                });
                
                // Create unison oscillators
                const masterGain = createUnisonOscillators(
                    parseFloat(frequencySlider.value),
                    waveformSelect.value,
                    parseFloat(detuneSlider.value)
                );
                
                // Connect: Unison Oscillators → ADSR Envelope → Filters → Volume → Destination
                masterGain.connect(adsrEnvelope);
                adsrEnvelope.chain(lowCutFilter, highCutFilter, volumeNode, Tone.Destination);
                
                // Start all oscillators
                oscillators.forEach(({ oscillator }) => {
                    oscillator.start();
                });
                
                // Trigger ADSR envelope
                adsrEnvelope.triggerAttack();
                
                isPlaying = true;
                playBtn.textContent = "Stop Note";
                statusDiv.textContent = `Playing ${oscillators.length}-voice unison...`;
                statusDiv.style.background = "#1565c0";
                
                console.log(`Started ${oscillators.length}-voice unison with ADSR`);
                
            } catch (error) {
                console.error("Error playing note:", error);
                statusDiv.textContent = "Error playing note";
                statusDiv.style.background = "#c62828";
            }
        }
        
        // Function to stop note with ADSR release
        function stopNote() {
            if (oscillators.length > 0 && isPlaying) {
                // Disconnect envelope to release
                const adsrEnvelope = volumeNode.input; // Get the envelope node
                
                if (adsrEnvelope && adsrEnvelope.triggerRelease) {
                    adsrEnvelope.triggerRelease();
                    
                    // Schedule oscillator stop after release completes
                    setTimeout(() => {
                        oscillators.forEach(({ oscillator }) => {
                            oscillator.stop();
                        });
                        oscillators = [];
                        isPlaying = false;
                        playBtn.textContent = "Play Note";
                        statusDiv.textContent = "Note stopped";
                        statusDiv.style.background = "#2e7d32";
                    }, parseFloat(releaseSlider.value) * 1000 + 100);
                } else {
                    // Fallback: immediate stop
                    oscillators.forEach(({ oscillator }) => {
                        oscillator.stop();
                    });
                    oscillators = [];
                    isPlaying = false;
                    playBtn.textContent = "Play Note";
                    statusDiv.textContent = "Note stopped";
                    statusDiv.style.background = "#2e7d32";
                }
            }
        }
        
        // Function to create audio nodes (filters and volume)
        function createAudioNodes() {
            // Create filters
            lowCutFilter = new Tone.Filter({
                frequency: parseFloat(lowCutSlider.value),
                type: "highpass"
            });
            
            highCutFilter = new Tone.Filter({
                frequency: parseFloat(highCutSlider.value),
                type: "lowpass"
            });
            
            // Create volume control
            volumeNode = new Tone.Volume(parseFloat(volumeSlider.value));
            
            console.log("Audio nodes created with filters and volume");
        }
        
        // Log initialization
        console.log("Synth with ADSR & Unison initialized");
    </script>
</body>
</html>
